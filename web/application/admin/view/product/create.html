{include file="layout/header" title="" keywords="" /}
<link href="__STATIC__/js/plugins/bootstrap-fileinput/css/fileinput.css" media="all" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="__STATIC__/js/plugins/kindeditor/themes/default/default.css" />
<link rel="stylesheet" href="__STATIC__/js/plugins/kindeditor/plugins/code/prettify.css" />
<link rel="stylesheet" href="__STATIC__/js/plugins/bootstrapvalidator/css/bootstrapValidator.css"/>
<script src="__STATIC__/js/plugins/bootstrap-fileinput/js/fileinput.js" type="text/javascript"></script>
<script type="text/javascript" src="__STATIC__/js/plugins/bootstrapvalidator/js/bootstrapValidator.js"></script>
<script type="text/javascript" src="__STATIC__/js/template-web.js"></script>
<script src="__STATIC__/js/plugins/kindeditor/kindeditor-all.js"></script>
<script src="__STATIC__/js/plugins/kindeditor/lang/zh-CN.js"></script>
<link rel="stylesheet" href="__STATIC__/js/plugins/select2/select2.css" />
<script src="__STATIC__/js/plugins/select2/select2.min.js" type="text/javascript"></script>
{include file="layout/left" groupId="$groupId" keywords="" /}
<style type="text/css">
    #custom-container > tr> td > input{
        width: 130px !important;
    }
</style>
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark"></h1>
                </div><!-- /.col -->
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">商品管理</a></li>
                        <li class="breadcrumb-item active">商品添加</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card card-primary">
                        <form id="add-form" role="form" action="{:url('')}" method="post"  ><!-- onsubmit="return validateSubmit()" -->
                            <div class="card-body">
                                <div class="form-inline form-group">
                                    <label  class="col-md-2">*选择供应商</label>
                                    <div class="col-md-5 no-padding">
                                        <div class="row">
                                          <select class="form-control col-md-6 select2" name="supplier_id">
                                                {volist name=":getSupplierList()"  id='user'}
                                                <option  value="{$user.id}">{$user.real_name}</option>
                                                {/volist}
                                          </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-inline form-group ajax-bind-change">
                                    <label for="" class="col-md-2">*所属类目</label>
                                    <div class="col-md-9 no-padding">
                                        <div class="row category-box" id="category-next-template-box">
                                        </div>
                                    </div>
                                </div>
                             
                                <div class="form-inline form-group">
                                    <label class="col-md-2">*商品名称</label>
                                    <div class="col-md-5 no-padding">
                                        <div class="row">
                                            <input type="text"  name="title" maxlength="30" class="form-control col-md-6" />
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="standard_container" class="js_ajax_bind_change"></div>
    
                                <div class="form-inline form-group">
                                    <label class="col-md-2">&nbsp;&nbsp;</label>
                                    <div class="col-md-5 no-padding">
                                        <div class="row">
                                                <p  class="help-block2" style="padding-top: 6px;padding-left: 5px;">
                                                    <input type="checkbox" class="js_specification_customization" /> 定制
                                                    定制价格：<input type="text"  name="title" maxlength="100" class="form-control" />元
                                                    定制单位：<input type="text"  name="title" maxlength="100" class="form-control" />
                                                </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="col-md-2">*产品主图</label>
                                    <div class="col-md-5 no-padding">
                                        <div class="row">
                                            <div class="col-md-6 no-padding">
                                                <input id="cover-file" name="file" type="file"   data-show-caption="true">
                                            </div>
                                            <p class="help-block2" style="padding-top: 6px;padding-left: 5px;">支持jpg、jpeg、png格式，大小不超过2.0M</p>
                                        </div>
                                        <div class="row">
                                            <input  type="hidden" name="cover_path" id="cover-upload-file"  value="" />
                                            <small class="help-block" style="padding-top: 6px;padding-left: 5px;"></small>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-inline form-group">
                                    <label  class="col-md-2">多视角图片</label>
                                    <div class="col-md-5 no-padding">
                                        <div class="row">
                                            <div class="col-md-6 no-padding">
                                                <input id="multi-file" name="file" type="file" data-show-caption="true"  multiple>
                                            </div>
                                            <p class="help-block2" style="padding-top: 6px;padding-left: 5px;">支持jpg、jpeg、png格式，大小不超过2.0M</p>

                                        </div>
                                        <div class="row">
                                            <input  type="hidden" name="multi_angle_img" id="multi-upload-file"  value="" />
                                            <small class="help-block" style="padding-top: 6px;padding-left: 5px;"></small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-inline form-group">
                                    <label for="" class="col-md-2">产地</label>
                                    <div class="col-md-5 no-padding">
                                        <div class="row">
                                            <select  id="goods_type" class="form-control col-md-2"  name="province_of_origin_id|city_of_origin_id|district_of_origin_id">
                                                <option  value="0">请选择</option>
                                                {foreach name=":getTypeLevelList(3)" id="type"}
                                                <option value="{$type.id}" >
                                                    {if $type.level == 2}&nbsp;&nbsp;&nbsp;&nbsp;|-&nbsp;{elseif $type.level == 3}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|-&nbsp;{/if}{$type.name}</option>
                                                {/foreach}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="col-md-2">商品详情APP/H5</label>
                                    <div class="col-md-7 no-padding">
                                        <div class="row">
                                            <textarea id="goods-content" class="textarea goods-content" placeholder="商品详情..."  name="content"  style="width: 100%; height: 200px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-inline form-group">
                                    <label class="col-md-2">商品详情Web</label>
                                    <div class="col-md-7 no-padding">
                                        <div class="row">
                                            <textarea id="web-goods-content" class="textarea goods-content" placeholder="商品详情..."  name="web_content"  style="width: 100%; height: 200px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer col-md-offset-2">
                                <button type="submit" class="btn btn-primary">添加</button>
                                <small class="submit-tip" style="padding-top: 6px;padding-left: 5px;color: #a94442"></small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

{include file="layout/footer" title="$title" keywords="" /}

<!-- 分类选择框start -->
<script id="next-template" type="text/html">
    {{ if lineType == 'next' }}
        <span class="select-level-div">
            <select class="form-control select-level next">
                <option  value="0">请选择</option>
                {{each categoryNextLevelList as value}}
                    <option value="{{value.id}}" >{{value.name}}</option>
                {{/each}}
            </select>
        </span>
    {{/if}}
    
    {{ if lineType == 'ready' }}
        <div class="select-level-div">
            <select class="form-control select-level">
                <option  value="0">请选择</option>
                {{each categoryNextLevelList as value}}
                    <option value="{{value.id}}" >{{value.name}}</option>
                {{/each}}
            </select>
        </div>
        <a href="javascript:;" id="category-add" style="padding-top: 6px;padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;继续添加</a>
        <input type="hidden" name='category_id[]' class="category-value-input">
    {{/if}}

    {{ if lineType == 'add' }}
        <div class="row category-box" style="margin-top: 10px;">
            <div class="select-level-div">
                <select class="form-control select-level">
                    <option  value="0">请选择</option>
                    {{each categoryNextLevelList as value}}
                        <option value="{{value.id}}" >{{value.name}}</option>
                    {{/each}}
                </select>
            </div>
            <a href="javascript:;" class="category-del" style="padding-top: 6px;padding-left: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;删除当前</a>
            <input type="hidden" name='category_id[]' class="category-value-input">
        </div>
    {{/if}}
</script>
<!-- 分类选择框end -->
<script>
    //
        // $(document).delegate('.color_select','change',function () {
        //     var t = $(this).prop("checked");
        //     var id = $(this).data('id');
        //     if(t == true){
        //         var data = {id:$(this).data('id'),name:$(this).data('name'),path:$(this).data('path')};
        //         // console.log(data);
        //         var html = template('color-template', data);
        //         $('#color-container').append(html);
        //         $(".color_file").fileinput({
        //             language: 'zh', //设置语言
        //             uploadUrl: '?s=admin/file/upload',  //上传地址
        //             showUpload: true, //是否显示上传按钮
        //             showRemove:true,
        //             dropZoneEnabled: false,
        //             showCaption: true,//是否显示标题
        //             allowedPreviewTypes: ['image'],
        //             allowedFileTypes: ['image'],
        //             allowedFileExtensions:  ['jpg', 'png','jpeg'],
        //             maxFileSize : 5120,
        //             maxFileCount: 20,
        //             uploadExtraData: function(previewId, index) {   //额外参数的关键点
        //                 var obj = {};
        //                 obj.type = 'goods_color';
        //                 return obj;
        //             }
        //         }).on('fileuploaded',function (event,data) {
        //             if(data.response){
        //                 $(event.target).closest('td').find('.color_hide_file').val(data.response.data.filename);
        //             }
        //         });
        //     }else{
        //         $('#color-container').find('tr[data-id="'+id+'"]').remove();
        //     }
        //     updateContainer();
        // });

        // //custom-container
        // var updateContainer = function () {
        //     //获取color对象
        //     var color = [];
        //     var option = [];
        //     //颜色选择框
        //     $(".color_select").each(function () {
        //         if($(this).prop('checked') == true){
        //             var obj ={id:$(this).data('id'),name:$(this).data('name'),path:$(this).data('path')};
        //             color.push(obj);
        //         }
        //     });

        //     //规格选择框
        //     $(".option_select").each(function () {
        //         if($(this).prop('checked') == true){
        //             var obj ={id:$(this).data('id'),name:$(this).data('name')};
        //             option.push(obj);
        //         }
        //     });

        //     var html = '';
        //     var index = 0;
        //     if(color.length > 0 && option.length > 0){
        //         for(var i=0; i< color.length; i++){
        //             for(var j=0;j<option.length; j++){
        //                 html +=template('custom-template',{index:index,color:g_color,option:g_option, color_id:color[i].id,color_name:color[i].name,path:color[i].path,option_id:option[j].id,option_name:option[j].name});
        //                 index++;
        //             }
        //         }
        //     }
        //     if(color.length == 0 && option.length > 0){
        //         for(var j=0;j<option.length; j++){
        //             html +=template('custom-template',{index:index,color:g_color,option:g_option,color_id:0,color_name:'',option_id:option[j].id,option_name:option[j].name});
        //             index++;
        //         }
        //     }
        //     if(color.length > 0 && option.length == 0){
        //         for(var i=0; i< color.length; i++){
        //             html +=template('custom-template',{index:index,color:g_color,option:g_option,color_id:color[i].id,color_name:color[i].name,path:color[i].path,option_id:0,option_name:''});
        //             index++;
        //         }
        //     }
        //     $('#custom-container').html(html);
        // }
    
    function getZuhe(){
        //获取有多少个组
        var zuhe = [];
        $('.js_attr_box').each(function(i,n){
            var len = $(n).find('.js_attr_checkbox:checked').length;
            var arr = [];
            $(n).find('.js_attr_checkbox:checked').each(function(ii,nn){
                arr.push($(nn).data('name'));
                if((ii+1) == len){
                    zuhe.push(arr);
                }
            })    
        });

        // console.log(zuhe);
        // console.log('zuhel:'+zuhe.length);
        var length = zuhe.length;
        var flag   = 0;
        var shengchengreturn  = null;
        while(flag<length){
            if(shengchengreturn==null){
                shengchengreturn = shengcheng(zuhe[flag],zuhe[flag+1]);
            }else{
                shengchengreturn = shengcheng(shengchengreturn,zuhe[flag+1]);
            }
            flag = flag+1;
        }

        console.log(shengchengreturn);
        // console.log('zzcc:'+shengchengreturn.length);
       // shengchengreturn = shengcheng(shengchengreturn,['R','G','B']);

        var html = '';
        for (var i = 0; i < shengchengreturn.length; i++) {
            // for (var ii = 0; ii < shengchengreturn[i].length; ii++) {
            //     shengchengreturn[i][ii] = shengchengreturn[i][ii].split('-');  
            // }
            console.log(shengchengreturn[i].split('-'));
            html +=template('custom-template',{'col1':shengchengreturn[i]});
        }
        $('#custom-container').html(zidingyi(html));

         // console.log(shengchengreturn);
        // console.log(shengcheng(zuhe[length-1],zuhe[length-2]));
        // console.log(shengcheng(['R','G'],['5','8']));
        // console.log(shengcheng(shengcheng(['R','G'],['5','8']),['+','-']));
     
    }

    $('.text-center').click(function(){
         $('#custom-container').html(zidingyi(''));
    })

    function zidingyi(html){
        if($('.js_specification_customization').prop('checked')){
            html +=template('custom-template',{'col1':['定制']});
        }
        return html;
    }

    function shengcheng(arr,add){
        var list = [];
        if(add == undefined){
            for (var i = 0; i < arr.length; i++) {
                console.log(typeof(arr[i]));
                console.log(arr[i]);
                if(typeof(arr[i]) == 'object'){
                    list.push([arr[i]]);
                }
            }
        }else{
            for (var i = 0; i < arr.length; i++) {
                for (var ii = 0; ii < add.length; ii++) {
                    if(typeof(arr[i]) == 'object'){
                        var newobj = JSON.parse(JSON.stringify(arr[i]));
                        newobj.push(add[ii]);
                        list.push(newobj);
                    }else{
                        list.push([arr[i],add[ii]]);
                    }
                }
            }
        }
        return list;
    }
    
    //点击规格选择框触发事件
    //
    $(document).delegate('.option_select','change',function () {
        updateContainer();
    });

    //点击颜色选择框触发事件
    $('.js_ajax_bind_change').on('change',".js_attr_box .js_attr_checkbox",function(){
        if( $(this).prop("checked")==true){ //选中
            // alert($(this).parents('.js_attr_box').find('.js_attr_checkbox:checked').length);
            //eval("var v="+$(this).parents('.js_attr_box').siblings('.js_attr_box_values').val());
            // $(this).parents('.js_attr_box').find('.js_attr_checkbox:checked').each(function(i,n){
            //     alert($(n).data('name'));
            //     //v.push($(n).data('name'));
            // })
            // $(this).parents('.js_attr_box').siblings('.js_attr_box_values').val(v);
        }else{ //去除选择
            
        }
             getZuhe();
    })

    
</script>
<!-- 规格组合桶 -->
<script id="custom-template" type="text/html">
    <tr data-color="{{color_id}}" data-option="{{option_id}}">
        <td>
            {{each col1 as colv}}
                {{each colv as colvv}}
                    <span class="js_attr_zuhe" data-attrid="{{colvv[0]}}" data-id="{{colvv[1]}}">{{colvv[2]}} </span>
                {{/each}}
            {{/each}}
        </td>
        <td>
            <select class="form-control"  name="unit">
                <option value="0" >自定义</option>
                {foreach name="unitRows" id="unit"}
                <option value="{$unit.id}" >{$unit.name}</option>
                {/foreach}
            </select>
            <input type="text" class="form-control col-md-3" value=""  name="standard[{{index}}][e_price]" />
        </td>
        <td>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="option1">
                <label class="form-check-label">是</label>
            </div>
        </td>
        <td><input type="number" class="form-control" value="0.00"  name="standard[{{index}}][e_price]" /></td>
        <td><input type="number" class="form-control" value="1"  name="standard[{{index}}][barcode]" /></td>
        <td>
            <button type="button" class="btn btn-primary btn-sm specification-picture">添加图片</button>
            <button type="button" class="btn btn-success btn-sm specification-price">设置价格区间</button>
            <button type="button" class="btn btn-danger btn-sm js_specification_delete">删除</button>

            <input type="hidden"  class="option_color_id" name="standard[{{index}}][color_id]"   value="{{color_id}}" />
            <input type="hidden"  class="option_option_id" name="standard[{{index}}][option_id]"  value="{{option_id}}"  />
            <input type="hidden"  class="option_color_name" name="standard[{{index}}][color_name]"  value="{{color_name}}"  />
        </td>
    </tr>
</script>

<!-- 规格模板桶 -->
<script id="specification-container" type="text/html" >
    {{each category_details as value}}
    <div class="form-inline form-group">
        <label class="col-md-2">{{value.attrName}}规格</label>
        <div class="col-md-9 no-padding js_attr_box js_attr_box{{value.attrId}}" data-attrid="{{value.attrId}}"  data-name="{{value.attrName}}">
            <div class="row">
                {{each value.attrList as v}}
                    <div class="col-md-2 col-sm-6" style="padding-bottom: 15px;padding-left: 0px">
                        <input type="checkbox"  data-id="{{v.id}}" data-name="{{value.attrId}}-{{v.id}}-{{v.name}}" class="js_attr_checkbox" value="{{v.id}}"  />
                        {{ if v.img }}
                            <img src="{{v.img}}" width="30px" height="30px"  />
                        {{/if}}
                        &nbsp;{{v.name}}
                    </div>
                {{/each}}
            </div>
        </div>
        <input type="hidden" class="js_attr_box_values" value="{}">
    </div>
    {{/each}}
    <div class="form-inline form-group">
        <label class="col-md-2">型号规格</label>
        <div class="col-md-9 no-padding js_attr_box js_attr_box42" data-attrid="42" data-name="型号">
            <div class="row">
                
                    <div class="col-md-2 col-sm-6" style="padding-bottom: 15px;padding-left: 0px">
                        <input type="checkbox" data-id="26" data-name="42-26-9000型号" class="js_attr_checkbox" value="26">
                        
                        &nbsp;9000型号
                    </div>
                
                    <div class="col-md-2 col-sm-6" style="padding-bottom: 15px;padding-left: 0px">
                        <input type="checkbox" data-id="27" data-name="8000型号" class="js_attr_checkbox" value="27">
                        
                        &nbsp;8000型号
                    </div>
                
            </div>
        </div>
        <input type="hidden" class="js_attr_box_values" value="{}">
    </div>

    <div class="form-inline form-group">
        <label class="col-md-2">&nbsp;&nbsp;</label>
        <div class="col-md-9 no-padding">
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-striped">
                        <thead >
                        <tr>
                            <th>组合规格</th>
                            <th>计量单位</th>
                            <th>是否电议</th>
                            <th>单价</th>
                            <th>起售数量</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="custom-container">
                            <tr>
                                <td colspan="6" class="text-center">未进行任何的规格组合</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="form-inline form-group">
        <label  class="col-md-2 pull-right">规格</label>
        <div class="col-md-9 no-padding">
            {{ if color}}
            <div class="row">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th >颜色(改名后可做商品自定义选项)</th>
                        <th>图片(选填)</th>
                    </tr>
                    </thead>
                    <tbody id="color-container"></tbody>
                </table>
            </div>
            {{/if}}
            
        </div>
    </div>
</script>
<!-- 分类选择start -->
    <script>
        function ajaxGetCategory(id,elm,htmlType,lineType){
            $.ajax({
                type:'get',
                url:'?s=admin/goods/getCategoryNextLevelList&parentId='+id,
                data:{},
                dataType:'json',
                success:function (data) {
                    if(data.status == 0){
                        if(data.data.list.length>0){
                            if(typeof(elm) == 'string'){
                                elm = $(elm);
                            }
                            var html = template('next-template',{categoryNextLevelList:data.data.list,lineType:lineType});
                            if(htmlType == 'html'){
                                elm.html(html);
                            }else if(htmlType == 'after'){
                                elm.after(html);
                            }
                        }
                        
                    }
                }
            });
        }
        
        //加载首个分类
        ajaxGetCategory(0,'#category-next-template-box','html','ready');

        //增加分类
        $('.ajax-bind-change').on('click',"#category-add",function(){
            if($('.ajax-bind-change .category-box').length>=5){
                alert('最多只能关联五个');
                return false;
            }
            ajaxGetCategory(0,'.ajax-bind-change .category-box:last','after','add');
        });

        //删除分类
        $('.ajax-bind-change').on('click',".category-del",function(){
            $(this).parent('.category-box').remove();
        });

        //给分类下的下拉框绑定事件
        $('.ajax-bind-change').on('change','.select-level',function () {
            var typeId = $(this).val();//获取当前选中的分类值
            $(this).siblings('.select-level-div').remove();//把当前触发的下拉框下级的去掉
            if(typeId>0){
                ajaxGetCategory(typeId,$(this),'after','next');
            }else{
                //获取上一级的选中分类值
                var preSelectValue = $(this).parents('.select-level-div').siblings('.select-level').val();
                if(preSelectValue!= undefined ){
                    typeId = preSelectValue;
                }
            }

            //选中的值赋值于input[type=hidden]
            $(this).parents('.category-box').children('.category-value-input').val(typeId);


            //所属类目必须项选中触发获取所有对应规格
            if($(this).parents('.category-box').attr('id')=='category-next-template-box'){
                if(typeId==0){
                    $('#standard_container').html('');
                }else{
                    $.ajax({
                        type:'get',
                        url:'?s=admin/goods/getCategoryDetailsAndOption&categoryId='+typeId,
                        data:{},
                        dataType:'json',
                        success:function (data) {
                            if(data.status == 0){
                                if(data.data.list.length > 0){
                                    var html = template('specification-container',{'category_details':data.data.list});
                                    $('#standard_container').html(html);
                                }else{
                                    $('#standard_container').html('');
                                }
                            }
                        }
                    })
                }
            }
        });
    </script>
<!-- 分类选择end -->



<script id="color-template" type="text/html">
    <tr data-id="{{id}}">
        <td>
            <div class="form-inline">
                <img src="{{path}}" width="30px" height="30px"  />&nbsp;&nbsp;
                <input type="text" class="form-control"  name="color[{{id}}][name]"  value="{{name}}" />
            </div>
        </td>
        <td>
            <input id="color-file"  class="color_file" name="file" type="file"  data-show-caption="true">
            <input  type="hidden"  class="color_hide_file" name="color[{{id}}][path]"   value="" />
            <p class="help-block">支持jpg、jpeg、png格式，大小不超过2.0M</p>
        </td>
    </tr>
</script>



<script type="text/javascript">
    var url = '{:url("admin/goods/index")}';
    $('a[href="'+url+'"]').addClass('active');
    $('a[href="'+url+'"]').parent().parent().parent().addClass('menu-open');
    function validateSubmit() {
        $('#cover-upload-file').closest('.form-group').removeClass('has-error');
        $('#cover-upload-file').closest('.form-group').find('.help-block').html('');
        $('.submit-tip').html('');
       // custom-container
        var customLength =  $('#custom-container').find('tr').length;

        var valid = true;
        //图片验证
        if ($('#cover-upload-file').val() == '') {
            $('#cover-upload-file').closest('.form-group').addClass('has-error');
            $('#cover-upload-file').closest('.form-group').find('.help-block').html('请上传封面图片');
            valid = false;
        }
        if(customLength == 0){
            $('.submit-tip').html('请设置商品规格');
            valid = false;
        }

        var result = $("#add-form").data('bootstrapValidator').isValid();
        if (result && valid) {
            return true;
        }
        return false;
    }

    //定义全局变量
      var g_color = 0;
      var g_option = 0;
    KindEditor.ready(function(K) {
        var editor1 = K.create('#goods-content', {
            cssPath : '__STATIC__/js/plugins/kindeditor/plugins/code/prettify.css',
            uploadJson : '/?s=admin/file/upload2',
            allowFileManager : true,
            afterCreate : function() {
            }
        });
        var editor2 = K.create('#web-goods-content', {
            cssPath : '__STATIC__/js/plugins/kindeditor/plugins/code/prettify.css',
            uploadJson : '/?s=admin/file/upload2',
            allowFileManager : true,
            afterCreate : function() {
            }
        });
    })

    
    // 单图上传
        $("#cover-file").fileinput({
            language: 'zh', //设置语言
            uploadUrl: '?s=admin/file/upload',  //上传地址
            showUpload: true, //是否显示上传按钮
            showRemove:true,
            dropZoneEnabled: false,
            showCaption: true,//是否显示标题
            allowedPreviewTypes: ['image'],
            allowedFileTypes: ['image'],
            allowedFileExtensions:  ['jpg', 'png','jpeg'],
            maxFileSize : 5120,
            maxFileCount: 1,
            uploadExtraData: function(previewId, index) {   //额外参数的关键点
                var obj = {};
                obj.type = 'goods_thumb';
                return obj;
            }
        });        
        $('#cover-file').on("fileuploaded", function(event, data) {
            if(data.response){
                $('#cover-upload-file').val(data.response.data.filename);
            }
        });
        $('#cover-file').on('fileclear', function(event,id) {
            $('#cover-upload-file').val('');
        });

    //多图上传
        $("#multi-file").fileinput({
            language: 'zh', //设置语言
            uploadUrl: '?s=admin/file/upload',  //上传地址
            showUpload: true, //是否显示上传按钮
            showRemove:true,
            dropZoneEnabled: false,
            showCaption: true,//是否显示标题
            allowedPreviewTypes: ['image'],
            allowedFileTypes: ['image'],
            allowedFileExtensions:  ['jpg', 'png','jpeg'],
            maxFileSize : 5120,
            maxFileCount: 20,
            uploadExtraData: function(previewId, index) {   //额外参数的关键点
                var obj = {};
                obj.type = 'goods';
                return obj;
            }
        });
        $('#multi-file').on("fileuploaded", function(event, data) {
            if(data.response) {
                var str = $('#multi-upload-file').val();
                var newStr = str ? str+'|'+data.response.data.filename : data.response.data.filename;
                $('#multi-upload-file').val(newStr);
                $('#multi-upload-file').closest('.form-group').removeClass('has-error');
                $('#multi-upload-file').closest('.form-group').find('.help-block').hide();
            }
        });
        $('#multi-file').on('fileclear', function(event) {
            $('#multi-upload-file').val('');
        });
    
   
</script>

<script>
    //商品供应商
    $(function () {
        $('.select2').select2();//{'theme':'jiahui'}
    })


    //所属分类指定的规格筛选
    $('#category-next-template-box .x .select-level').off('change',function (elm) {
            var typeId = $(this).val();
            if(typeId==0){return ;}
            var obj = $(this);
            

            // //获取分类规格
            // $.ajax({
            //     type:'get',
            //     url:'?s=admin/goods/getType&typeId='+typeId,
            //     data:{},
            //     dataType:'json',
            //     success:function (data) {
            //          if(data.status == 0){
            //                 g_color = data.data.color;
            //                 g_option = data.data.option;
            //              if(g_color == 1 || g_option == 1){
            //                  var data = {color:g_color,color_list:data.data.color_list,option:g_option,option_list:data.data.option_list,option_name:data.data.option_name}; //
            //                  var html = template('specification-container',data);
            //                  $('#standard_container').html(html);
            //              }else{
            //                  $('#standard_container').html('');
            //              }
            //          }
            //     }
            // });
        });

        //更新组合
        var updateChecked = function () {
            if(g_color){
                var selectedColorId = [];
                $(".option_color_id").each(function () {
                    selectedColorId.push($(this).val());
                });
                $(".color_select").each(function () {
                    $(this).prop("checked",false);
                    if($.inArray($(this).val(),selectedColorId) >= 0){
                        $(this).prop("checked",true);
                    }
                })
                //删除
                $("#color-container").find("tr").each(function () {
                    var t = $(this).data('id');
                    if($.inArray(t+'',selectedColorId) == -1){
                        $(this).remove();
                    }
                })
            }
            if(g_option){
                var selectedOptionId = [];
                $(".option_option_id").each(function () {
                    selectedOptionId.push($(this).val());
                })

                $(".option_select").each(function () {
                    $(this).prop("checked",false);
                    if($.inArray($(this).val(),selectedOptionId) >= 0){
                        $(this).prop("checked",true);
                    }
                })
            }
        }

        //组合规格删除当前
        $(document).delegate('.specification-delete','click',function () {
            $(this).closest('tr').remove();
            updateChecked();//更新check选中值
        });
</script>
<style>
.select2-container .select2-selection--single{height: 38px;}
.select2-container--default .select2-selection--single{border-color: #ced4da;}
.select2-container--default .select2-selection--single .select2-selection__rendered{line-height: 38px;}
.select2-container--default .select2-selection--single .select2-selection__arrow{top: 4px;}
</style>